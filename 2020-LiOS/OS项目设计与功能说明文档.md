



## 项目设计与功能说明文档



小组成员：

陈子杰 	1850106

马天放 	1750773

黎力     	1853549 

黄伟杰	 1850107

霍定镭     1850110

指导教师：张慧娟

提交时间：2020-08-23



### 项目概述

---



####  项目目的

在经过一学期的操作系统课程学习之后，我们对操作系统的各个模块，如进程、内存、文件系统等有了较为清晰的了解，课程中的小项目也让我们大致了解了其代码实现。但是，我们对于这些模块如何整合在一起，共同运作并最终共同构成一个文件系统还有一定的疑问。因此，本项目的目的是让我们跟着书籍一起实现一个简单的操作系统，真正了解如何将课本上的知识整合成一个操作系统，并发挥自己的创造力，将一些自己的创新点加入操作系统中。



#### 开发环境

a.基于32位Ubuntu开源GNU/Linux操作系统

b.使用Bochs开源模拟器



#### 项目指标

本门操作系统课程设计中，5人为一组，利用《Orange’s 一个操作系统的实现》书中提供的源代码，通过修改或者重新实现参考源码的一个或多个模块来实现一个简单的操作系统。

本系统主要针对文件系统进行重新实现，其中新增代码量达到文件模块代码的一半，主要增加了文件夹的隐藏、上锁功能，并将源代码的扁平状文件系统修改为树状文件系统实现**B**级项目难度；在参考源码的基础上实现系统级应用，如磁盘，工具台等，通过调用较多的系统API以实现对系统的检测和控制，实现**C级**项目难度；同时实现了用户级应用，实现**D级**项目难度。



### 设计方案

---



#### 概述

本系统参考《Orange’s 一个操作系统的实现》书中提供的源代码，重新实现了文件系统部分，可以针对文件/目录进行增删改写操作，同时实现了多级目录，可在不同层级目录中进行转换，并实现了文件夹的隐藏、上锁功能；同时通过调用部分系统API实现一些系统小游戏，并且增加了特别的开机动画。



#### 系统功能结构及使用说明

---

##### 开机动画

◆ 描述

进入系统后，代表本操作系统名称的“LiOS”字样从屏幕四边进入，随后按顺时针淡出界面，3秒后自动消失。

◆ 实现方法

开机动画使用逐帧printf的方式实现，通过设置较小的延迟时间形成动画效果。

![截屏2020-08-23 下午8.11.28](/Users/chenzijie/Desktop/截屏2020-08-23 下午8.11.28.png)

---

##### 用户登录

◆ 描述

开机动画结束后，屏幕打印“Please enter yoiur password!"，用户输入密码，密码正确则进入程序。如多次密码输入错误，则需等待一段时间才能再次输入密码。

◆ 实现方法

使用一个变量记录设置的密码，并在用户输入密码后进行比对。如多次错误，则在循环中增加delay_time，以增加等待时间。

![截屏2020-08-23 下午8.13.33](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.13.33.png)

----

##### 帮助页面

◆ 描述

开机动画结束后，系统自动显示欢迎界面，用户输入“help”指令后，显示当前指令列表，方便用户进行相应操作；指令输入区“[root@localhost: / ]”显示当前路径，“/”表示当前所在目录为根目录。

◆ 实现方法

用户输入指令后，系统通过判断字符串调用对应API，进入相应功能（详见下文）。

![截屏2020-08-23 下午8.13.50](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.13.50.png)

---



---

##### 清屏功能

◆ 描述

用户输入“clear”命令后，系统进行清屏，显示上图初始欢迎界面。

◆ 实现方法

通过调用clear() API实现清屏功能，同时重新设置控制台相应初始值。 

![截屏2020-08-23 下午8.14.21](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.14.21.png)

---

##### 文件管理功能

本文件功能使用树状文件系统，参考linux文件系统的指令进行指令设计，同时加入windows文件系统下的隐藏文件夹与文件上锁功能，



显示目录文件列表

◆ 描述

用户输入“ls”指令，系统打印出当前文件目录下的全部文件及目录。 

◆ 实现方法

通过调用ls()方法向文件系统发送LS系统消息，当文件系统接收到消息之后会执行do_ls()方法，该方法会通过遍历当前节点下的子节点来打印当前目录下的文件信息。打印的内容包括子节点的inode编号，对应的文件类型和对应的文件名。

![截屏2020-08-23 下午8.15.19](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.15.19.png)

---

###### 创建文件

◆ 描述

用户输入“touch + filename”指令，在当前目录下创建一个新的文件并命名，若创建成功则系统提示“file created”的消息，若创建失败则系统提示“failed to create a new file”的消息。

◆ 实现方法

通过调用CreateFile()方法，该方法会调用open()方法来进行创建。根据方法返回值判断是否创建成功并给用户发出反馈消息。其中创建文件时会对文件进行重名检测。 



---

###### 删除文件/文件夹 

◆ 描述

用户输入“rm+filename”指令，删除指定文件名的文件或文件夹（由于不允许相同目录下文件重名，所以此处可以使用文件名进行搜索），删除成功后系统提示“deleted”，若删除失败（当前目录下不存在该文件）则会出现删除失败的信息。

◆ 实现方法

调用DeleteFile()方法，向文件系统发送UNLINK消息，文件系统在接收到消息之后会调用do_unlink()方法进而实现文件或文件夹的删除。其中文件夹的删除实现是递归删除文件夹里的子节点。 

![截屏2020-08-23 下午8.18.51](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.18.51.png)

---

###### 打印文件内容

◆ 描述

用户输入“cat+filename”指令，查看该文件内容，若文件中已写入内容，则如上图显示；若文件创建后未写入内容，则打印空行；若找不到文件则显示“fail to open”；若找到文件后打开失败则显示“An error has occured in reading the file”。

◆ 实现方法

首先使用open()方法定位文件，然后调用read()方法对文件进行读操作。 

![截屏2020-08-23 下午8.19.50](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.19.50.png)

---

###### 写文件

◆ 描述

用户输入“vi+filename”指令，系统在定位到目标文件后显示文件路径，之后用户输入要写入文件的内容并回车，完成写文件操作。

◆ 实现方法

首先使用open()方法定位文件，然后调用write()方法对文件进行写操作。

![截屏2020-08-23 下午8.19.36](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.19.36.png)

---

###### 创建目录

◆ 描述

用户输入“mkdir + directoryname”指令，在当前目录内创建一个目录。

◆ 实现方法

首先使用CreateDir()方法创建对应文件路径，然后调用open()方法来检测是否有同名文件，如果有的话则会提示"Failed to create a new directory with name”。如果没有重名文件夹创建文件夹，成功或失败都会有相应提示信息。 

![截屏2020-08-23 下午8.18.08](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.18.08.png)

---

###### 进入多级目录

◆ 描述

用户输入“cd + directoryname”指令，系统自动检索目录路径，检索成功后，指令输入区的路径由“ / ”更改为“ /directoryname/ ”，表示当前处于目标目录中。如果输入”cd ..”则会返回上一层。

◆ 实现方法

调用GoDir()方法，首先根据输入的目录名获得目标的绝对路径，并根据获得的绝对路径调用open()方法打开相应的文件。 若想返回上一级，则会根据’/’找到目标位置，再将绝对路径修改为对应路径并更新；若想进入下一级，则将当前目标路径与目标文件夹名拼合，打开文件，直接修改路径并更新。

![截屏2020-08-23 下午8.20.18](/Users/chenzijie/Library/Application Support/typora-user-images/截屏2020-08-23 下午8.20.18.png)

---

###### 隐藏文件夹

◆ 描述

◆ 实现方法

---

###### 显示隐藏文件夹

◆ 描述

◆ 实现方法

---

###### 文件夹上锁

◆ 描述

◆ 实现方法

---

###### 文件夹解锁

◆ 描述

◆ 实现方法

---

##### 小游戏

本操作系统实现了一些系统小游戏功能。



###### 扫雷

◆ 描述

◆ 实现方法



---

###### 推箱子

◆ 描述

用户输入“game”命令后看到游戏列表，选择“game2”命令进入到推箱子游戏界面；系统根据预设好的数据绘制游戏地图，然后用户通过键盘输入WASD控制人物移动并推动箱子；箱子全部移动到目标地点后游戏胜利，出现死局或用户不希望继续游戏，程序提供按键Q供用户随时退出游戏。

◆ 实现方法

调用startGame()方法进入游戏，程序内包含多种函数分别达到控制人物移动、即时地图绘制等功能。

---

###### 井字棋

◆ 描述

用户输入“game3”指令，进入井字棋游戏界面；首先系统打印空白棋盘（chessboard），然后用户通过输入棋子行、列位置来与系统下棋，直至出现平局或赢家；用户中途可以输入回车直接退出游戏界面，返回初始欢迎界面。

◆ 实现方法

调用TTT()方法，其中调用多个九宫棋相关函数，获取用户的键盘输入，共同实现井字棋游戏的游戏操作。

---

###### 2048

◆ 描述

用户输入“game4”指令，进入2048游戏界面；系统自动打印游戏方法、游戏界面以及当前分数；用户每次只能输入一个运动方向，系统自动刷新棋盘及分数，同时在棋盘内随机生成新的数字。

◆ 实现方法 

调用start2048Game()方法，其中调用多个2048相关函数，获取用户的键盘输入，共同实现2048的游戏操作。

![1941598166316_.pic_hd](/Users/chenzijie/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/4f2c236d0700a2f5e162cfd9314cdae6/Message/MessageTemp/f8ca4cfb42adeadb7cd3110b36121a79/Image/1941598166316_.pic_hd.jpg)

---

##### 进程系统

本操作系统实现了进程管理，进程间通信，进程切换等功能。



###### 进程管理功能

◆ 描述

用户输入“process”指令，进入进程管理功能，系统打印出当前全部进程（包括系统进程和用户进程）的pid，名称，优先级（15表示系统级进程，5表示用户级进程）以及运行状态（YES表示正在运行，NO表示没有运行）。

◆ 实现方法

通过调用ProcessManage() API，遍历整个进程列表，并逐个打印。

![截屏2020-08-23 下午8.14.05](file:///Users/chenzijie/Library/Application%20Support/typora-user-images/%E6%88%AA%E5%B1%8F2020-08-23%20%E4%B8%8B%E5%8D%888.14.05.png?lastModify=1598185251)

---

###### 进程间通信

◆ 描述

用户输入“messageA/B/C”向进程A/B/C发送消息，接下来输入想要发送的消息，发送成功则会在两边进程进行提示。（按下alt+f1/f2/f3可切换到进程A/B/C对应的终端）

◆ 实现方法

通过调用messageA/B/C()API，利用send_recv函数，将输入的文本作为消息的一个参数，进行进程间的消息发送与接收来达成进程间通信。

![71598112297_.pic_hd](/Users/chenzijie/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/4f2c236d0700a2f5e162cfd9314cdae6/Message/MessageTemp/6c8303bc1f93e69fbd0870a23c53cfc1/Image/71598112297_.pic_hd.jpg)

###### ![81598112297_.pic_hd](/Users/chenzijie/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/4f2c236d0700a2f5e162cfd9314cdae6/Message/MessageTemp/6c8303bc1f93e69fbd0870a23c53cfc1/Image/81598112297_.pic_hd.jpg)

---

###### 进程切换

◆ 描述

用户输入“processA/B/C”切换到进程A/B/C。（按下alt+f1/f2/f3可切换到进程A/B/C对应的终端）用户可在切换后的进程进行后续操作，比如向进程A/B/C发送消息。
<<<<<<< HEAD

◆ 实现方法

通过调用processA/B/C()API，利用进程接收消息的阻塞状态，通过进程间通信更改process_running变量确保当前只有一个进程在运行，其他两个进程处于接收消息的阻塞状态，来实现进程的切换。

=======

◆ 实现方法
>>>>>>> 8337b2543661ddfd353d8af7c646941afbb0d983

通过调用processA/B/C()API，利用进程接收消息的阻塞状态，通过进程间通信更改process_running变量确保当前只有一个进程在运行，其他两个进程处于接收消息的阻塞状态，来实现进程的切换。



![101598112315_.pic_hd](/Users/chenzijie/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/4f2c236d0700a2f5e162cfd9314cdae6/Message/MessageTemp/6c8303bc1f93e69fbd0870a23c53cfc1/Image/101598112315_.pic_hd.jpg)



![111598112316_.pic_hd](/Users/chenzijie/Library/Containers/com.tencent.xinWeChat/Data/Library/Application Support/com.tencent.xinWeChat/2.0b4.0.9/4f2c236d0700a2f5e162cfd9314cdae6/Message/MessageTemp/6c8303bc1f93e69fbd0870a23c53cfc1/Image/111598112316_.pic_hd.jpg)







**四、成员分工**



| **姓名**   | **学号** | **分工**                                               | **占比** |
| ---------- | -------- | ------------------------------------------------------ | -------- |
| **陈子杰** | 1850106  | 开机动画功能实现；日历、时间功能实现；2048游戏功能实现 | 20%      |
| **马天放** | 1750773  | 指令、帮助功能实现；文件夹隐藏、上锁功能实现           | 20%      |
| **黎力**   | 1853549  | 文件系统功能实现；推箱子小游戏实现                     | 20%      |
| **黄伟杰** | 1850107  | 扫雷小游戏功能实现；井字棋小游戏功能实现               | 20%      |
| **霍定镭** | 1850110  | 进程系统功能实现；进程间通信、进程切换功能实现         | 20%      |
